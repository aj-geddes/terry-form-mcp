FROM hashicorp/terraform:latest

# Install Python and dependencies
RUN apk add --no-cache \
    python3 \
    py3-pip \
    curl \
    bash \
    jq \
    && pip3 install --no-cache-dir fastmcp asyncio

# Install terraform-ls
RUN curl -Lo terraform-ls.zip https://releases.hashicorp.com/terraform-ls/0.33.2/terraform-ls_0.33.2_linux_amd64.zip && \
    unzip terraform-ls.zip && \
    mv terraform-ls /usr/local/bin/ && \
    chmod +x /usr/local/bin/terraform-ls && \
    rm terraform-ls.zip

# Create workdir
WORKDIR /app

# Copy server files
COPY server_enhanced_with_lsp.py /app/
COPY terry-form-mcp.py /app/
COPY terraform_lsp_client.py /app/

# Set workspace mount point
VOLUME /mnt/workspace

# Run the server
CMD ["python3", "server_enhanced_with_lsp.py"]